import { pipe, Array } from 'effect';
import { RecordOps } from '@midnight-ntwrk/wallet-sdk-utilities';
const calculateBalances = (coins) => coins.reduce((acc, { coin }) => ({
    ...acc,
    [coin.type]: acc[coin.type] === undefined ? coin.value : acc[coin.type] + coin.value,
}), {});
export const makeDefaultCoinsAndBalancesCapability = () => {
    const getAvailableBalances = (state) => {
        const availableCoins = getAvailableCoins(state);
        return calculateBalances(availableCoins);
    };
    const getPendingBalances = (state) => {
        const pendingCoins = getPendingCoins(state);
        return calculateBalances(pendingCoins);
    };
    const getTotalBalances = (state) => {
        const availableBalances = getAvailableBalances(state);
        const pendingBalances = getPendingBalances(state);
        return pipe([availableBalances, pendingBalances], RecordOps.mergeWithAccumulator(0n, (a, b) => a + b));
    };
    const getAvailableCoins = (state) => {
        const pendingSpends = new Set([...state.state.pendingSpends.values()].map(([coin]) => coin.nonce));
        return pipe([...state.state.coins], Array.filter((coin) => !pendingSpends.has(coin.nonce)), Array.map((coin) => {
            return {
                coin,
                commitment: state.coinHashes[coin.nonce].commitment,
                nullifier: state.coinHashes[coin.nonce].nullifier,
            };
        }));
    };
    const getPendingCoins = (state) => pipe([...state.state.pendingOutputs.values()], Array.map(([coin, ttl]) => ({
        coin,
        ttl,
        commitment: state.coinHashes[coin.nonce].commitment,
        nullifier: state.coinHashes[coin.nonce].nullifier,
    })));
    const getTotalCoins = (state) => [...getAvailableCoins(state), ...getPendingCoins(state)];
    return {
        getAvailableBalances,
        getPendingBalances,
        getTotalBalances,
        getAvailableCoins,
        getPendingCoins,
        getTotalCoins,
    };
};
